---
import { Icon } from 'astro-icon';

const headers = {
	Authorization: `Bearer ${import.meta.env.GH_API_KEY}`,
};

async function data() {
	// Fetch your recent GitHub projects sorted by last recent commit
	const totalCommits = [];
	const response = await fetch(
		'https://api.github.com/users/tverderesi/repos?sort=pushed&direction=desc&per_page=10&offset=0',
		{ headers }
	);
	const projects = await response.json();
	await Promise.all(
		projects.map(async (project) => {
			let allCommits = 0;
			let page = 1;
			let totalPages = 1;
			while (page <= totalPages) {
				const commitsResponse = await fetch(
					`https://api.github.com/repos/tverderesi/${project.name}/commits?page=${page}&per_page=100`,
					{
						headers,
					}
				);

				const commits = await commitsResponse.json();
				const totalCount = commits.length;
				totalPages = parseInt(response.headers.get('link').match(/&page=(\d+)>; rel="last"/)[1], 10);
				allCommits += totalCount;

				page++;
			}

			totalCommits.push(allCommits);
		})
	);

	return { projects, totalCommits };
}
const { projects, totalCommits } = await data();
---

<div class="grid gap-6 row-gap-5 md:grid-cols-2 lg:grid-cols-4 -mb-6">
	{
		projects.map((project, idx) => (
			<article class="mb-6 transition">
				<div class="relative h-0 lg:h-64 overflow-hidden bg-gray-400 dark:bg-slate-700 rounded shadow-lg mb-6">
					<h3 class="mb-2 text-xl font-bold leading-snug sm:text-2xl font-heading ">
						<a
							href={project.html_url}
							class="hover:text-primary-600 underline underline-offset-4 decoration-1 decoration-dotted transition ease-in duration-200"
						>
							{project.name}
						</a>
					</h3>
					<div class="flex flex-col justify-between items-center h-1/2">
						<div class="flex items-center flex-1 basis-1/3">
							<Icon name="mdi:source-commit" class="w-5 h-5 mr-1 text-primary-500" />
							<span class="text-sm text-gray-600 dark:text-gray-400">{totalCommits[idx]}</span>
						</div>
						<div class="flex items-center flex-1 basis-1/3">
							<Icon name="ic:star" class="w-5 h-5 mr-1 text-yellow-500" />
							<span class="text-sm text-gray-600 dark:text-gray-400">{project.stars}</span>
						</div>
						<div class="flex items-center flex-1 basis-1/3">
							<Icon name="mdi:source-branch" class="w-5 h-5 mr-1 text-gray-500" />
							<span class="text-sm text-gray-600 dark:text-gray-400">{project.forks}</span>
						</div>
					</div>
				</div>
			</article>
		))
	}
</div>
